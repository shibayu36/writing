こんにちは、クラスター株式会社でソフトウェアエンジニアをやっているid:shiba_yu36:detailです。

僕は最近クラスター株式会社の開発フローで、QAフローを最適化し、品質水準を満たしながらリリースまでの期間を最短化する取り組みを行いました。今回はその取り組みについて紹介します。

[:contents]

### これまでの課題

#### 課題1: コード変更からリリースまでの期間が長い
クラスター株式会社はメタバースプラットフォームである「cluster」というサービスを提供しています。このサービスでの障害を最小に抑えるため、リリース時にはQAチームによる非常に手厚いQAフローを運用していました。

以前のコード変更〜QA〜リリースまでの全体像を図にしたものがこちらです。

TODO: https://miro.com/app/board/uXjVNXW_cl8=/?moveToWidget=3458764646568977296&cot=14 の図を追加

簡単な流れを説明すると

- ある機能やバグ修正を次のリリースに含めるときは、QA週より前の木曜日までにコード変更を完了し、開発チーム内で動作確認を行なっておく
- 金曜にrelease用のgit branchを作成する
- QA週にQAチームが1週間かけてテストを行う。主に3つのQAを行う。
    - 新機能QA: 新規開発した機能について詳細にテストを行う。月〜水曜に行う
    - regression QA: サービスの主要機能が全て動作するかを包括的にテストする。水〜木曜に行う
    - バグ修正確認: 今回のリリースに含まれるバグ修正が正しく動作するかテストする。水曜 or 木曜に行う
- 木曜にQA承認されたら、開発チームがiOS/Androidアプリの審査を提出する
- 審査が通過したら、QAの翌週の月曜にリリースを行う

このQAフローによって、サービスの障害は非常に少ない状態に保たれていました。しかし一方で、コード変更からリリースまで最短でも12日かかってしまうという課題がありました。

コード変更からリリースまでの期間が長いと、次のような問題が起きます。

- あるリリースでバグが発覚しても、直してリリースするまで2週間かかってしまう
- 作ったものを早くユーザーに届けられない。結果としてユーザーの反応から素早く学びサービス改善に活かすことがしづらい。

そこで障害数をコントロールした上で、リリースまでの期間を最短化するため、QAフローを最適化したいと考えました。

#### 課題2: リリースQAとコンテンツQA両方が必要でQAチームの負荷が高い
前述したQAはリリースQAについてでした。実はQAチームはコンテンツQAというもう一つのQAを行なっており、このためQAチームの負荷が高いという課題もありました。

clusterでは、一般ユーザー向けにサービス提供している以外に、3D空間を活用した施策を実施した企業向けに空間制作を受注するという事業も行なっています。この事業のために、弊社には3D空間制作チームがあります。

TODO: https://prtimes.jp/main/html/rd/p/000000364.000017626.html のメタメタ大作戦の事例を載せる

この3D空間を制作し、企業さまへ納品するとき、3D空間自体が仕様どおりに動いているかを品質保証する必要があります。そのため、QAチームが納品ごとに3D空間をテストしており、これをコンテンツQAと呼んでいます。

QAチームは開発チームによるサービスリリースのためのリリースQAと、3DCGチームによる空間制作のためのコンテンツQAの両方を行なっていて、チームの負荷が高い状況でした。

### 改善全体方針と改善後のフロー
これら2つの課題を解決するため、全体的な方針は次のようにしました。

- サービスとしてのQAはQAメンバーと相談し最適なテストケースを決めた上で開発チームが行い、障害数をコントロールした上でリリースまでの期間を短縮する
- QAチームにはコンテンツQAに集中してもらい、企業向けの事業の品質水準を担保した上で、負荷を軽減する

改善後の開発チームのサービスリリースフローは次のようになりました。

TODO: https://miro.com/app/board/uXjVNXW_cl8=/?moveToWidget=3458764646569550590&cot=14 の図を追加

- 水曜までに機能開発者は自分以外の数名集めて動作確認を完了しておく
- 水曜夕方にrelease用のgit branchを作成する
- 木曜に開発チーム全員が集まり、新機能QA、regression QA、バグ修正確認を一気に終わらせる
    - 2時間程度で完了させられるように、QAのテストケースは調整した
- 木曜夕方にQA含めてリリース承認を行い、iOS/Androidアプリの審査を提出する
- 審査が通過したら、翌週の月曜にリリースを行う

このフローによって、コード変更からリリースまでの期間を最短で5日程度に短縮できました。またこのフローを実施し始めてから半年経ちましたが、顕著な障害増加は起こっておらず、品質もコントロールできています。

### サービスリリースの改善後のQAフローに到達するために何を行なったか
ここまでで、これまでのサービスリリースのQAフローにどのような課題があり、改善して最終的にどのようなQAフローになったかを説明しました。

ではこのサービスリリースの改善後のQAフローに到達するために、どのような手順で改善を進めたかを紹介します。大まかには次のような手順で実施していきました。

1. 事業の特性を理解して達成したい品質基準を決める
2. 開発フローの制約条件を理解する
3. 達成したい品質条件や制約条件を満たすように、QAフローおよびその周辺の開発フローを設計する
4. QAメンバーと一緒に、regression QAのテストケースを決め直す
5. 決定した最終形に向けて移行計画を作り、徐々に移行していく

ではそれぞれの手順について説明します。

#### 1. 事業の特性を理解して達成したい品質基準を決める
開発チームでサービスのリリースQAを引き継ぐ場合、開発リソース的に今までの1週間の手厚いフローをそのまま引き継ぐことは難しいです。そのためQAの中で重要な部分のみ抽出する必要があります。

QAの中で重要な部分は何かを知るためには、事業やサービスの特性を理解し、達成したい品質基準を決めると良いと考えました。

clusterの場合、サービスのコアになっているのは、「ユーザーが作成した3D空間内で複数人がアバターで同期的に遊べる」という体験です。サービス利用ユーザーはもちろん、企業さまもこのコア体験を活用し3D空間内でイベントなどを行なっています。

TODO: 3D空間での複数人での同期的体験の写真を追加

TODO: この辺流れが微妙

そのため、この体験が担保できていることが最も重要であると考えました。

これらから、サービスとして最低限の品質基準を「3D空間内で複数人が同期的に遊べている体験を担保できていること」としました。この部分は自動テストでチェックしづらいポイントなので、そういう意味でもQAすべきポイントと考えました。

#### 2. 開発フローの制約条件を理解する
さらに開発フローやQAを調整するにあたって、変更しづらい制約条件を理解しておかなければ、理想的なフローを設計することはできません。関係各所にヒアリングしつつ整理したところ、次のような制約条件を意識しておく必要があると分かりました。

- 開発チームでQAをやるとしても、週に数時間程度が望ましい
    - 理由: QAを増やしすぎると今度は開発時間が取れなくなり、機能開発ができなくなってしまうため
- リリースは今のまま月曜午前で固定する
    - 理由: 企業さまとの案件の関係でリリース周りもビジネスメンバーとのコミュニケーションが必要だが、その調整のためにもリリース曜日は固定したい
- アプリ審査はiOSが最も遅く、たいていは24時間で終わるが、もっと伸びることもある

#### 3. QAフローおよびその周辺の開発フローを設計する
ここまでで、達成したい品質基準と開発フローの制約条件を理解できました。これらを踏まえて、QAフローおよびその周辺の開発フローを設計していきます。以下の思考の流れで開発フローを整理しました。

- 審査が24時間以上かかる可能性があり、かつ月曜にリリースしたいなら、木曜夜には審査提出し金曜中に審査が終わっていて、あとは月曜にリリースするだけという状態にしたい
- 木曜夜に審査を提出するなら、逆算すると木曜昼〜夕方にQAを終わらせたい
- 開発チームで全員で集まって木曜昼に一気にQAを終わらせるのが最短のやり方であろう。ミーティング調整の関係で13:00~15:00の2時間で終わらせる方法が良いだろう
- 木曜昼のQAの前に一度も新機能の動作確認していないのは困る。逆算すると水曜までにせめて機能開発している人が動作確認をし、何かバグが見つかったら修正した上でQAに持ってきてもらう

この結果、次のようなコード変更〜リリースまでが6日ほどの開発フローを目指すことにしました。

TODO: 開発フローの図を追加

- 機能開発した人は、最悪でも水曜までに開発環境で動作確認をし、バグを見つけたら修正を終わらせておく
- 水曜夕方にrelease用のgit branchを作成する
- 木曜の昼に開発チーム全員が集まり、新機能QA、regression QA、バグ修正確認を一気に終わらせる
- 木曜夕方にQA含めてリリース承認を行い、iOS/Androidアプリの審査を提出する
- 審査が通過したら、翌週の月曜にリリースを行う

#### 4. QAメンバーと一緒に、regression QAのテストケースを決め直す
目指す開発フローとして、木曜に2時間で一気にQAを終わらせると決めました。この時間内で「3D空間内で複数人が同期的に遊べている体験を担保できていること」を満たせるようなテストケースを考えなければなりません。

まずは既存のregression QAのテストケースに詳しいQAメンバーと一緒に必要最低限の項目をピックアップしていきました。ここは非常に地道な作業で、二人で既存QAテストケースを眺めながら

- 複数人の同期的な体験の担保のためのテストケースのみピックアップ
- さらにそのテストケース群に対して、利用頻度などを考慮し、1つ1つ重要度付けていく
- 時間内で終わらせられる範囲で、重要度順にテストケースを選定していく

という作業をしました。

この作業の後、僕の方で開発チームがQAしやすいような粒度にテストケースを調整し、最終的に70ほどのテストケースを作りました。

TODO: https://docs.google.com/spreadsheets/d/1BDCPKguwLBG-LhQ9-N0D2QRo8MprBakZqDlIqd53es0/edit?gid=2047577187#gid=2047577187 からテストケースの様子の画像をとってくる。


#### 5. 決定した最終形に向けて移行計画を作り、徐々に移行していく
ここまでで最終形の開発・QAフローと、regression QAのテストケースを決められました。しかしフローの変化が大きいため、一気に変更すると混乱が生まれると考えました。

そこで少しずつ移行していく計画を作り、開発チームがQAしていくフローに徐々に慣れていくようなやり方を取りました。具体的には

- リリースまでの期間は変えずに、regression QAとバグ修正確認のみを開発チームに移行し、2週間ほど実施する
    - TODO: https://miro.com/app/board/uXjVNXW_cl8=/?moveToWidget=3458764646638438685&cot=14 の図を追加
- regression QAとバグ修正確認を問題なく行えたら、さらに新機能QAを開発チームに移行する
    - TODO: https://miro.com/app/board/uXjVNXW_cl8=/?moveToWidget=3458764646638522911&cot=14 の図を追加
- 開発チームでのQAに慣れてきたら、コード変更〜QA〜リリースまでの期間を短縮する

ここまでで計画を作れたので、あとは淡々と実施しながら問題が起きたら調整をしていきました。

### 移行後の結果
何度も再掲しますが、移行後のフローは次のようになりました。

TODO: https://miro.com/app/board/uXjVNXW_cl8=/?moveToWidget=3458764646569550590&cot=14 の図を追加

まず図にあるように、コード変更〜リリースまでの期間を最短で6日ほどに短縮できました。この結果、バグ修正リリースに時間がかかる、作ったものを早くユーザーに届けられないという2つの課題が改善されました。

このフローを今年初めから実施し始めてからしばらく経ちましたが、

- 2024年に発生した障害数が25件に対し、2025年に発生した障害数は16件ほど
- サービス完全ダウン・特定の重要な機能が全く使えなくなるなどのクリティカルな問題も起きていない

という状況となっており、障害数をコントロールできていることが確認できました。

またQAチームから開発チームにサービスのQAを引き継いだことで、逆にQAチームはコンテンツQAに集中できる状況も作り出せました。

これらから最初の課題であった、「コード変更からリリースまでの期間が長い」「リリースQAとコンテンツQA両方が必要でQAチームの負荷が高い」という2つの課題が解決できたのではないかと感じています。

### まとめ
TODO: 
