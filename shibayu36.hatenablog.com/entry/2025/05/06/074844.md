---
Title: クロマ・サブサンプリングについて調べた
Category:
- tech
Date: 2025-05-06T07:48:44+09:00
URL: https://blog.shibayu36.org/entry/2025/05/06/074844
EditURL: https://blog.hatena.ne.jp/shiba_yu36/shibayu36.hatenablog.com/atom/entry/6802418398410971387
---

複数のpngを全部pdfに結合する処理を書いていて、その中でJPEG圧縮について興味が湧いた。JPEG圧縮全体はまだ全く理解出来てなかったけど、その工程の中のクロマ・サブサンプリングについて調べたのでメモしておく。間違ってる可能性も高いので、ツッコミあれば教えてください。

### そもそもJPEGの圧縮の流れ
ChatGPTに聞いたら次の流れのようだ。逆順をたどれば復元できるが、量子化で捨てた分は戻らない。

1. 色を人間の感じ方に合わせて変換（RGB → YCbCr）
2. 色差成分を間引き（サブサンプリング）
3. 画像を 8×8 ピクセルの小さなブロックに分割
4. 各ブロックに離散コサイン変換（DCT）をかけて「周波数成分」に分解
5. 高い周波数ほど粗く丸める（量子化）＝ここが“劣化”ポイント
6. ゼロが並びやすい順に並べ直し（ジグザグスキャン）
7. ゼロの連続を短い記号で表現し、ハフマン符号でさらに圧縮

これの2でクロマ・サブサンプリングをしている。

### YCbCr
RGBからの可逆変換で、RGBと違い色の情報だけサンプリングしやすい。人間は輝度に対して色差の変化を感じにくいことを利用して情報を圧縮することができる。

雑に言うとYは輝度（グレースケール）、Cbは青っぽさ、Crは赤っぽさを表す数字になっていて、この3つを使うことで色を表現する。

### クロマ・サブサンプリング
YCbCrでCbCrだけをサンプリングする。imagemagickなどで `-sampling-factor 4:2:0` と指定しているが、この情報はクロマ・サブサンプリングに使われている。

[クロマ・サブサンプリング - Wikipedia](https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AD%E3%83%9E%E3%83%BB%E3%82%B5%E3%83%96%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AA%E3%83%B3%E3%82%B0)の図がわかりやすい。4:2:0をJ:a:bと表した時

- J：水平サンプリング基準（概念的な領域の幅）。通常は4。
- a：Jピクセルの最初の行のクロマサンプル（Cr、Cb）の数。
- b：Jピクセルの最初の行と次の行のクロマサンプル（Cr、Cb）の変化量。

と表現される。それぞれのsampling-factorの変換のイメージはWikipediaの画像がわかりやすい。
[f:id:shiba_yu36:20250506074239p:plain]

### サンプリングした後のフォーマット
データ構造的にサンプリングしただけでデータ量が減るんだっけ？と疑問に思ったが、これはYUVフォーマットという形式を調べるとデータ量が減ることがわかる。参考: [YUVフォーマットの違いを世界一分かりやすく解説 #OpenCV - Qiita](https://qiita.com/Yossy_Hal/items/8e0b9676698ba552c210)。

視覚的にはこの図を見るとわかりやすい。

[f:id:shiba_yu36:20250506074626p:plain:w300]
