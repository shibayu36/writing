---
Title: symfonyのフォームの登録時に値を変換したい場合
Category:
- 日記
Date: 2010-03-11T17:24:56+09:00
URL: https://blog.shibayu36.org/entry/20100311/1268295896
EditURL: https://blog.hatena.ne.jp/shiba_yu36/shibayu36.hatenablog.com/atom/entry/12704591929888039267
---


　formクラス内にprocessValues関数を記述することで、登録時に値変換を行うことができる。
　例えば、ユーザにパスワード入力させて、暗号化した後、暗号化に使ったsaltと暗号化済みパスワードをデータベーステーブルに登録したい場合を考える。

<hr width="100%" size="2" />1．データベース定義
　テーブル名はuser,カラムはid, name, salt, sha1_passwordとする。schemaは以下のようになる。
<blockquote>database:
&#160; user:
&#160;&#160;&#160; id: ~
&#160;&#160;&#160; name: 
&#160;&#160;&#160;&#160;&#160; type: varchar(80)
&#160;&#160;&#160; salt:
&#160;&#160;&#160;&#160;&#160; type: varchar(32)
&#160;&#160;&#160; sha1_password:
&#160;&#160;&#160;&#160;&#160; type: varchar(40)</blockquote>　このとき、symfonyは上のカラム定義に沿ったBaseUserFormクラスを自動生成する。

<hr width="100%" size="2" />2．ユーザパスワード入力用ウィジェットの作成
　sha1_passwordは暗号化した後のカラムであり、ユーザに入力した内容のバリデートをすることができない。symfonyのフォームクラスではカラムで定義している以外のものもウィジェットとして登録できるため、ユーザパスワード入力用のウィジェットを作成する。UserFormクラスのconfigureオペレーションを以下のように変更する。

<blockquote>&lt;?php 

class UserForm extends BaseUserForm
{
&#160; public function configure()
&#160; {
&#160;&#160;&#160; 
&#160;&#160;&#160; $this->widgetSchema[&#39;password&#39;] = new sfWidgetFormInputPassword();
&#160;&#160;&#160; $this->validatorSchema[&#39;password&#39;] = new sfValidatorString(
&#160;&#160;&#160;&#160;&#160; array(
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#39;min_length&#39; => 6,
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#39;max_length&#39; => 15,
&#160;&#160;&#160;&#160;&#160; ),
&#160;&#160;&#160;&#160;&#160; array(
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#39;min_length&#39; => &#39;パスワードは６文字以上にしてください&#39;,
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#39;max_length&#39; => &#39;パスワードは１５文字以下にしてください&#39;
&#160;&#160;&#160;&#160;&#160; )
&#160;&#160;&#160; );
&#160;&#160;&#160; 
&#160;&#160;&#160; $this->useFields(
&#160;&#160;&#160;&#160;&#160; array(&#39;name&#39;, &#39;password&#39;)
&#160;&#160;&#160; );
&#160; }
}</blockquote>
　これによって入力項目はユーザ名、暗号化していないパスワードとなり、入力させたパスワードをバリデートすることができるようになった。

<hr width="100%" size="2" />3．登録時の変換
　もちろん上の状態では、テーブルにないカラムがあるため、そのままではデータベースに登録することはできない。そのため、登録時に値を変換する。
　symfonyの場合、登録前に必ずprocessValuesという関数を通すため、これを利用して値を変換し、登録するときにはname, salt, sha1_passwordとして登録するようにする。UserFormクラスは最終的に以下のようになる。

<blockquote>&lt;?php 

class UserForm extends BaseUserForm
{
&#160; public function configure()
&#160; {
&#160;&#160;&#160; 
&#160;&#160;&#160; $this->widgetSchema[&#39;password&#39;] = new sfWidgetFormInputPassword();
&#160;&#160;&#160; $this->validatorSchema[&#39;password&#39;] = new sfValidatorString(
&#160;&#160;&#160;&#160;&#160; array(
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#39;min_length&#39; => 6,
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#39;max_length&#39; => 15,
&#160;&#160;&#160;&#160;&#160; ),
&#160;&#160;&#160;&#160;&#160; array(
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#39;min_length&#39; => &#39;パスワードは６文字以上にしてください&#39;,
&#160;&#160;&#160;&#160;&#160;&#160;&#160; &#39;max_length&#39; => &#39;パスワードは１５文字以下にしてください&#39;
&#160;&#160;&#160;&#160;&#160; )
&#160;&#160;&#160; );
&#160;&#160;&#160; 
&#160;&#160;&#160; $this->useFields(
&#160;&#160;&#160;&#160;&#160; array(&#39;name&#39;, &#39;password&#39;)
&#160;&#160;&#160; );
&#160; }
&#160; 
&#160; /**
&#160;&#160; * フォーム入力値をオブジェクトに渡す前に行う処理
&#160;&#160; *
&#160;&#160; * @param array $values フォームフィールドに入力され、バリデーションを経た値の配列
&#160;&#160; * @return array 処理を行った後の値の配列
&#160;&#160; */
&#160; public function processValues($values)
&#160; {
&#160;&#160;&#160; $password = $values[&#39;password&#39;];
&#160;&#160;&#160; unset($values[&#39;password&#39;]);
&#160;&#160;&#160; 
&#160;&#160;&#160; $salt = md5(microtime().mt_rand());
&#160;&#160;&#160; $sha1_password = sha1($password.$salt);
&#160;&#160;&#160; 
&#160;&#160;&#160; $values[&#39;salt&#39;] = $salt;
&#160;&#160;&#160; $values[&#39;sha1_password&#39;] = $sha1_password;
&#160;&#160;&#160; 
&#160;&#160;&#160; return $values;
&#160; }
}</blockquote>

これにより、登録時には値が変換されて、暗号化されたパスワードが登録される。
